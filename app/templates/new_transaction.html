{% extends 'base.html' %}
{% block content %}
{% include "navbar.html" %}
    <section class="h-auto">
        <div class="page-wrapper">
            <form id="submit-transaction" method="POST" action="">
                <div class="row">
                    <div class="col-lg-8 col-md-12 col-sm-12">
                        <div class="page-header">
                            <div class="search-bar">
                                <input 
                                    class="new-sale"
                                    type='text' 
                                    name='q' 
                                    onkeyup="searchProducts(event)" 
                                    placeholder="Scan or Search items...." 
                                />
                                <svg width="37" height="37" viewBox="0 -10 35 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g clip-path="url(#clip0)">
                                    <path d="M15.4895 0.942474C19.4982 0.942474 23.1268 2.48284 25.7537 4.9734C28.3807 7.46396 30.0054 10.9044 30.0054 14.7049C30.0054 18.3533 28.5081 21.6693 26.0647 24.1323C26.1091 24.1633 26.1521 24.1978 26.1927 24.2359L36.6431 34.1301C37.0809 34.5428 37.0833 35.2144 36.6474 35.6297C36.212 36.045 35.5036 36.0467 35.0659 35.634L24.6154 25.7398C24.549 25.6772 24.4928 25.6088 24.4463 25.5362C21.9788 27.3725 18.8691 28.4677 15.4892 28.4677C11.4806 28.4677 7.85138 26.9273 5.22442 24.4367C2.59775 21.9462 0.973022 18.5054 0.973022 14.7049C0.973022 10.9044 2.59775 7.46396 5.22472 4.9734C7.85168 2.48312 11.4809 0.942474 15.4895 0.942474ZM24.1308 6.51234C21.9193 4.4157 18.8643 3.11887 15.4895 3.11887C12.1148 3.11887 9.05941 4.4157 6.84794 6.51234C4.63647 8.60898 3.26861 11.5054 3.26861 14.7049C3.26861 17.9044 4.63647 20.8012 6.84794 22.8978C9.05911 24.9944 12.1145 26.2913 15.4895 26.2913C18.8643 26.2913 21.9193 24.9944 24.1308 22.8978C26.3423 20.8014 27.7101 17.9047 27.7101 14.7049C27.7101 11.5054 26.3423 8.60898 24.1308 6.51234Z" fill="#383232"/>
                                    </g>
                                    <defs>
                                    <clipPath id="clip0">
                                    <rect width="36" height="35" fill="white" transform="translate(0.973022 0.942474)"/>
                                    </clipPath>
                                    </defs>
                                </svg>
                            </div>
                            <select id="products" class="select-product" onchange=selectProduct(event) multiple></select>
                            <div class="buttons-wrapper">
                                <button id="cancel" class="button" type="button">
                                    Cancel Sale
                                </button>
                            </div>
                        </div>
                        {% for message in get_flashed_messages() %}
                            <div class="alert alert-warning">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                {{ message }}
                            </div>
                        {% endfor %}
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                            <div class="table-responsive table-wrapper">
                                <div class="row">
                                    <div class="cart-header">
                                        <h3>Bag Items</h3>
                                    </div>

                                    <div id="bag-item" class="bag-item">
                                        <div class="load-msg on text-center">
											<h4>There are no items in the cart</h4>
										</div>
                                    </div>
                                    
                                </div>
                            </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="right-side">
                            <div class="right-inner">
                                <div class="right-values">
                                    <label for="subtotal" class="col-form-label">Subtotal</label>
                                    <input id="subtotal" type="text" class="reset form-control" id="subtotal" data-original-value="0.00" value="0.00" readonly>
                                </div>
                                <input id="totalCost" type="hidden" name="totalCost" value="0.00" readonly />
                                <div class="right-values">
                                    <label for="discount" class="col-form-label">Discount</label>
                                    <input id="discount" type="text" class="reset form-control" id="discount" data-original-value="0.00" value="0.00" readonly>
                                </div>
                                <div class="right-values">
                                    <label for="payMethod" class="col-form-label">Pay Method</label>
                                    <select class="refresh" id="refSel" onchange=showRef()>
                                        <option value="CASH">CASH</option>
                                        <option value="CARD">CARD</option>
                                    </select>
                                </div>
                                <div id="ref" class="right-values ref">
                                    <label for="posRef" class="col-form-label">POS Ref</label>
                                    <input type="text" class="restore form-control" id="posRef" data-original-value="" />
                                </div>
                                <div class="right-values">
                                    <label for="total" class="col-form-label">Total</label>
                                    <input id="total" type="text" class="reset form-control" data-original-value="0.00" value="0.00" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ctrl-btns">
                        <div class="buttons-wrapper">
                            <button id="prtReceipt" type="button" class="button">Print</button>
                        </div>
                        <div class="buttons-wrapper">
                            <button id="save" type="button" class="button-save">Save</button>
                        </div>
                        <div class="buttons-wrapper">
                            <button id="saveLater" type="button" class="button-later" onclick="saveToLocalStorage(event)">Save for Later</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    <script>
        $('document').ready(function(){
            var username = "{{current_user.username}}"
            var firstLetter = username.charAt(0)
            
            document.getElementById("user").innerHTML = firstLetter;
        });
    </script>
    <script src="{{ url_for('static', filename= 'js/transactions.js') }}"></script>
    <script>
        $("#save").on("click", function() {
            var userID = "{{current_user.id}}";
            var shopID = "{{current_user.shop_id}}";
            var productID = $('input[id=prd]').map(function(){return $(this).val();}).get();
            var quantity = $('input[class=quant]').map(function(){return $(this).val();}).get();
            var amount = document.getElementById("total").value;
            var cost = document.getElementById("totalCost").value;
            var payMethod = document.getElementById('refSel').value;
            var posRef = document.getElementById('posRef').value;
            var token =  $('input[name="csrf_token"]').attr('value');

            $.ajaxSetup({
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRFToken', token);
                }
            });
            $.ajax(
                {
                    type: "POST",
                    url: "{{ url_for('auth.submitTransaction') }}",
                    data: JSON.stringify(
                        {
                            "userID": userID,
                            "shopID": shopID,
                            "productID": productID, 
                            "quantity": quantity,
                            "amount": parseFloat(amount.substring(1)),
                            "cost": parseFloat(cost),
                            "payMethod": payMethod,
                            "posRef": posRef
                        }
                    ),
                    contentType: 'application/json;charset=UTF-8',
                    success: function (response) { 
                            $('.page-wrapper').prepend(`
                                <div class="alert alert-warning">
                                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                                    ${response.message}
                                </div>
                            `)
                            
                            if(response.status === 201) {
                                $( ".items" ).remove();
                                $('.load-msg').addClass('on');

                                $('.refresh').change(function(){});
                                $('.refresh').prop('selectedIndex',0).trigger('change');
                                $(".reset").each(function(){
                                    var $t = $(this);
                                    $t.val($t.data("original-value"));
                                });
                                var posref = $("input#posRef");
                                posref.val(posref.data("original-value"));
                            }
                    }
                }
            )
        });

        let contentWidth = $(window).width();

        if (contentWidth < 600) {
            $('.admin-table').addClass('mobile-table');
        } else {
            $('.admin-table').removeClass('mobile-table');
        }
    </script>
{{super()}}
{% endblock scripts %}