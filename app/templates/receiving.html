{% extends "admin-layout.html" %}
{% block inner %}
    <section class="h-auto">
        <div class="page-wrapper">
            <form id="submit-transaction" method="POST" action="">
                <div class="row">
                    <div class="col-lg-8 col-md-12 col-sm-12">
                        <div class="page-header">
                            <div class="search-bar">
                                <input 
                                    class="new-sale"
                                    type='text' 
                                    name='q' 
                                    onkeyup="searchProducts(event)" 
                                    placeholder="Scan or Search items...." 
                                />
                            </div>
                            <select id="products" class="select-product" onchange=selectProduct(event) multiple></select>
                            <div class="buttons-wrapper">
                                <a id="cancel" class="button" type="button">
                                    Cancel Received
                                </a>
                                <a href="{{ url_for('auth.addProduct') }}" id="cancel" class="button-later" type="button">
                                    New Item
                                </a>
                            </div>
                        </div>
                        {% for message in get_flashed_messages() %}
                            <div class="alert alert-warning">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                {{ message }}
                            </div>
                        {% endfor %}
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                            <div class="table-responsive table-wrapper">
                                <div class="row">
                                    <div class="cart-header">
                                        <h3>Received Items</h3>
                                    </div>

                                    <div id="bag-item" class="received-item">
                                        <div class="load-msg on text-center">
                                            <h4>There are no items in the cart</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                    <div class="check-supplier col-lg-8 col-md-12 col-sm-12">
                        <div class="page-header">
                            <div class="buttons-wrapper">
                                <button id="cancel" class="button-later" type="button">
                                    <svg width="13" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9.20777 0.792318C9.20777 0.68571 9.22925 0.583496 9.26799 0.489746C9.30852 0.39209 9.36727 0.304688 9.43986 0.232096C9.58309 0.0887044 9.78133 0 9.99992 0C10.107 0 10.2094 0.0214844 10.3031 0.0603841C10.3051 0.0611979 10.3069 0.0621745 10.3092 0.063151C10.4042 0.103516 10.4893 0.161296 10.5603 0.232259C10.7037 0.375488 10.7924 0.57373 10.7924 0.79248C10.7924 0.797363 10.7921 0.802246 10.7914 0.806966V9.20866H19.1929C19.1976 9.20817 19.2028 9.20768 19.2075 9.20768C19.3143 9.20768 19.4167 9.22917 19.5104 9.26807C19.5127 9.26888 19.5145 9.26986 19.5164 9.27083C19.6115 9.3112 19.6966 9.36898 19.7676 9.43994C19.911 9.58317 20 9.78141 20 10C20 10.1064 19.9784 10.2088 19.9396 10.3026C19.8993 10.4002 19.8405 10.4876 19.7676 10.5602C19.6952 10.6327 19.6081 10.6914 19.5104 10.7319V10.7321C19.4167 10.7708 19.3143 10.7923 19.2075 10.7923C19.2028 10.7923 19.1976 10.792 19.1929 10.7913L10.7914 10.7915V19.193C10.7921 19.1978 10.7924 19.2028 10.7924 19.2077C10.7924 19.3145 10.7707 19.417 10.732 19.5106C10.731 19.5129 10.7301 19.5146 10.7291 19.5166C10.6887 19.6117 10.6311 19.6968 10.5603 19.7677C10.4166 19.9113 10.2185 20 9.99992 20C9.89347 20 9.7911 19.9785 9.69735 19.9396C9.59969 19.8993 9.51229 19.8405 9.4397 19.7677C9.36727 19.6955 9.30852 19.6082 9.26799 19.5106H9.26783C9.22893 19.417 9.20744 19.3145 9.20744 19.2077C9.20744 19.2028 9.20777 19.1978 9.20842 19.193V10.7915H0.80696C0.80224 10.7922 0.797357 10.7925 0.792311 10.7925C0.685867 10.7925 0.583491 10.771 0.489742 10.7321C0.392087 10.6917 0.304685 10.633 0.232094 10.5602C0.159667 10.4878 0.100911 10.4007 0.0603836 10.3031V10.3031C0.0214842 10.2093 0 10.1069 0 10C0 9.89339 0.0214842 9.79118 0.0603836 9.69743C0.100911 9.59977 0.159667 9.51237 0.232257 9.43978C0.375648 9.29639 0.573726 9.20768 0.792474 9.20768C0.79752 9.20768 0.802402 9.20801 0.807122 9.20866H9.20875V0.806966C9.2081 0.802083 9.20777 0.797201 9.20777 0.792318Z" fill="black"/>
                                    </svg>
                                </button>
                            </div>
                            <div id="searchBar" class="search-bar">
                                <input 
                                    class="new-sale"
                                    type='text' 
                                    name='search' 
                                    onkeyup="searchSuppliers(event)" 
                                    placeholder="Search for supplier... or click button to add new" 
                                />
                            </div>
                            <select id="suppliers" class="select-supplier" onchange=selectSupplier(event) multiple></select>
                            <input id="supplier_id" type="hidden" value="" />
                        </div>
                    </div>
                    <div class="ctrl-btns">
                        <div class="buttons-wrapper">
                            <button id="save" type="button" class="button-save">Save</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
{% endblock inner %}
{% block scripts %}
    <script src="{{ url_for('static', filename= 'js/suppliers.js') }}"></script>
    <script>
        $("#save").on("click", function() {
            var userID = "{{current_user.id}}";
            var shopID = "{{current_user.shop_id}}";
            var productID = $('input[id=prd]').map(function(){return $(this).val();}).get();
            var quantity = $('input[class=quant]').map(function(){return $(this).val();}).get();
            var amount = document.getElementById("total").value;
            var cost = document.getElementById("totalCost").value;
            var payMethod = document.getElementById('refSel').value;
            var posRef = document.getElementById('posRef').value;
            var token =  $('input[name="csrf_token"]').attr('value');

            $.ajaxSetup({
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRFToken', token);
                }
            });
            $.ajax(
                {
                    type: "POST",
                    url: "{{ url_for('auth.submitTransaction') }}",
                    data: JSON.stringify(
                        {
                            "userID": userID,
                            "shopID": shopID,
                            "productID": productID, 
                            "quantity": quantity,
                            "amount": parseFloat(amount.substring(1)),
                            "cost": parseFloat(cost),
                            "payMethod": payMethod,
                            "posRef": posRef
                        }
                    ),
                    contentType: 'application/json;charset=UTF-8',
                    success: function (response) { 
                            $('.page-wrapper').prepend(`
                                <div class="alert alert-warning">
                                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                                    ${response.message}
                                </div>
                            `)
                            
                            if(response.status === 201) {
                                $( ".items" ).remove();
                                $('.load-msg').addClass('on');

                                $('.refresh').change(function(){});
                                $('.refresh').prop('selectedIndex',0).trigger('change');
                                $(".reset").each(function(){
                                    var $t = $(this);
                                    $t.val($t.data("original-value"));
                                });
                                var posref = $("input#posRef");
                                posref.val(posref.data("original-value"));
                            }
                    }
                }
            )
        });

        let contentWidth = $(window).width();

        if (contentWidth < 600) {
            $('.admin-table').addClass('mobile-table');
        } else {
            $('.admin-table').removeClass('mobile-table');
        }
    </script>
{{super()}}
{% endblock scripts %}